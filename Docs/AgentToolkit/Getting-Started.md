# Agent Toolkit

The Agent Toolkit (AT) is an open-source library that provides a simplified interface to interact with the events generated by the Plaiground server.

## Set up

First of all, be sure that on your system you have installed a version of Python which is equal or greater than `3.9`.

### Using Poetry

The AT uses [Poetry](https://python-poetry.org/docs/) as it's package manager. So you'll first need to set it up by following the [official instructions](https://python-poetry.org/docs/#installation) for your system.

If you want the environment created in the current directory (which we recommend), set the following configuration. The virtualenv will be created and **expected** in a folder named `.venv` within the root directory of the project. More info [here](https://python-poetry.org/docs/configuration/#virtualenvsin-project)

```bash
$ poetry config virtualenvs.in-project true
```

Once that's done, you can enter the root of your project, in this case `AgentToolkit` and create a virtual environment for the project and install all the dependencies with the command:

```bash
$ poetry install
```

Use the following command to enter the virtualenv created by poetry.

```bash
$ poetry shell
```

However, it is strongly recommended that you set up the Poetry integration with your IDE
PyCharm CE is the recommended one, but it is also possible to do with VSCode, refer to your IDE documentation regarding how to do this.

Note: in case poetry does not create an environment with your desired python version, you can change it using:
```bash
poetry env use <your python version>
```

### Using conda/pip

First ensure you have correctly generated the plaiground client form OpenAPI.

Create a new conda/pip environment using Python `3.9`. You will need to manually install each of the dependencies with the following commands.

```
conda create -n greenland python=3.9
cd ClientGeneration/PythonClient
pip install -e .
cd ../../AgentToolkit
pip install -e .
```


### Task runner

The Agent Toolkit project is also set up to use the [Just](https://github.com/casey/just) task runner (in short, Just is a modern alternative to `Make`).
You can see which tasks are available, and their documentation, by simply running `just` from the root of the AT project. To run a task use `just {task}`.

### Notation

| Term                            | Definition                                                                                                                                        |
| ------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| _Server_ or _Plaiground server_ | Minecraft server where games develop                                                                                                              |
| _Plaiground Client_             | Automatically generated Python client based on an OpenAPI specification. It is used by the Agent Toolkit to operate over Events.                  |
| _Online mode_              | The scenario where the Event Client is connecting to the Plaiground server to play against Gamers, receiving and sending Events through Event Hub |
| _Offline mode_             | The scenario where the Event Client is connecting to a local dummy server simulated using multiple processes.                                 |

## Components

![image.png](.attachments/at_internal_modules.png)

### Model

The Model is a machine learning system that receives a vectorial dense representation of the Game State and returns an action to perform, with its corresponding parameters. The agent is stateless, meaning that a single instance of an agent can play multiple games simultaneously. All the information necessary to make the next prediction is encoded in the Game State. A model can be executed in a different compute instance and play multiple simultaneous games.

### Agent

The `Agent` class is a wrapper around the Model which has the same functionalities. The Agent is executed in the same instance as the Environment. Its main functionalities are:

- To connect the Environment to the model.
- To calculate the reward function by comparing the current Game State with the Target Game State.


### Agent Toolkit class

The `AgentToolkit` class handles the connection between the Event source, or any other message server, for multiple games. It has three main functionalities:

1. On startup, publish AgentReady events
1. Read the incoming events:
  - If the event is of type `PlatformGameStartEvent` and for an unknown Game, assume Agent will play in the game
    - Start a new `GameThread` instance to track the game
    - Adds new GameThread to list of active games for future event delegation
  - Else, forward event to corresponding `GameThread`
1. Publish events representing actions predicted by the agent to the event source.

### Event client

Abstracts the connection with any other source of Events (EventHub or Training Dataset). Must inherit from `BaseMessageClient`.

### AgentGameState

In RL, some models receive as input a Markovian representation of the game state. In other words, they expect a full description of the MC world that aggregates the Initial Game State and all the changes that happened since the start of the Game. The `AgentGameState` contains information that defines the current state of the game/world.

#### Complete Initial Game State

When a game starts, the AT needs to receive all the information to build the `AgentGameState` from scratch.

In the context of the Service, the Initial World State is stored as a generator string. However, the Agent Toolkit needs the Complete Initial Game State: a the grid of blocks saved in a data structure

**TODO** complete with implementation of how we will retrieve this information.

## Connection between AT and server

### Example of interactions to start a game

[![](https://mermaid.ink/img/pako:eNqVU9tKxDAQ_ZUhIKyw7gf0QShaFnyQon0syNBO22Ca1DRdKeK_O7ms9fZiHsLQOefkzEn6JhrTksjETC8L6YZuJfYWx1oDrwmtk42cUDs4FoAzHHEkqAZL2P6G5JWH5D1xXRmjnqX7DSo9plRLL3WtYzuvrq6vyywyH1h63R0Ohz00AypFuqcn2e7BGuWLy8gpI6XQbHshwHBoZ-xG-oYrUdoEepVugGEZUcOkcCU7A-oWZuLNGeh5wo2aV8wNqDsjtZ--OLHILkg9zWRPson2PC8UUXRzGqY7FhnccGqO2PJJWqNH72WXWAkad2XMFA4NmvDdjI8HyHuYw7ib3c9zHv0kf0KORVLZIDEODo0T4yA6RzbdIDZOmh839F9eSj-fJrWeLcmO815jn-XOj-DiIo4bPn2d-N442a1guh_9z3lvaXbWJMXzEnsxkh1Rtvy433yvFm4gTkJkXLZon2tR63fGLVPL91K00hkrsg7VTHuBizOPq25E5uxCZ1D6OxLq_QPsMgyw?type=png)](https://mermaid.live/edit#pako:eNqVU9tKxDAQ_ZUhIKyw7gf0QShaFnyQon0syNBO22Ca1DRdKeK_O7ms9fZiHsLQOefkzEn6JhrTksjETC8L6YZuJfYWx1oDrwmtk42cUDs4FoAzHHEkqAZL2P6G5JWH5D1xXRmjnqX7DSo9plRLL3WtYzuvrq6vyywyH1h63R0Ohz00AypFuqcn2e7BGuWLy8gpI6XQbHshwHBoZ-xG-oYrUdoEepVugGEZUcOkcCU7A-oWZuLNGeh5wo2aV8wNqDsjtZ--OLHILkg9zWRPson2PC8UUXRzGqY7FhnccGqO2PJJWqNH72WXWAkad2XMFA4NmvDdjI8HyHuYw7ib3c9zHv0kf0KORVLZIDEODo0T4yA6RzbdIDZOmh839F9eSj-fJrWeLcmO815jn-XOj-DiIo4bPn2d-N442a1guh_9z3lvaXbWJMXzEnsxkh1Rtvy433yvFm4gTkJkXLZon2tR63fGLVPL91K00hkrsg7VTHuBizOPq25E5uxCZ1D6OxLq_QPsMgyw)

1. `AgentToolkit` sends `AgentReadyEvent(..., challenge_id, agent_service_id)` message to server.

    - `challenge_id`: identifies the challenge where the Agent will be participating. It allows the service to know which Roles can be assigned to this Agent.
    - `agent_service_id`: a uuid assigned to the agent. The Service will recognize the agent based on this id, and provide a new player id for the game.

1. Server enqueues one or more agents as a regular player and eventually assigns a game to them.
1. Server sends `PlatformPlayerJoinsGameEvent(agent_service_id, game_id, player_id, â€¦)` event after it initializes a game. The `agent_service_id` must be in the list originally sent by the AT in the `AgentReadyEvent`.
1. AT receives `PlatformPlayerJoinsGameEvent`, that indicates the agent a new game has begun and its assigned `player_id`. It creates a `GameThread` instance to handle the game in a new process. All events received by the AT with the corresponding `game_id` will be forwarded to the `GameThread` through internal queues. Conversely, the `GameThread` will send Events to the AT to represent Agent actions, and the AT will forward them to EventHub.
1. Inside the `GameThread`, the `GameEnvironment` keeps track of the current game state. It is initialized when the game begins, and it can create its initial state from events send by the server or from an external source like Azure Storage.
1. Once the `GameEnvironment` has constructed the initial game state, the main Game loop starts:

    - `GameThread` listens for changes in server (via the AT) and updates `GameState`.
    - `GameThread` sends new `GameState` to `Agent` and receives the next action to perform.
    - `GameEnvironment` applies the action into the local game state. Through a callback system, the environment sends the events that reflect the changes performed to the game state.
    - The Server receives the events with the changes to the game state and applies them to the Minecraft world.

1. Eventually, the server sends Game end message.


## Class diagrams

This is a simplified diagram (it doesn't include absolutely every class and all their fields), but should be enough to give a good idea of how the classes interact and through which methods/fields.

[![](https://mermaid.ink/img/pako:eNqtWI1v27oR_1cIAUPtxXabJk1jIwjQl7VdgLboe8negM1DSksnm4tE6pFUXK8v_dt3R-qDkuW8FZgRxLJ0PN7H73531LcoVglEi-hPzYctJf67yrgxLBF8rXnOUqWZ3QB7r0WyVTpLjt7cMq7jjbAQ21IDi5U0IgEt5Bqv80JJkNYwkRcZ5HgJiVO72rHr9x_-5q7dP_rFYtoMDNvwB2Bcsi8Xl3T_C0sFZG5h_VlKv0qyYmc3SrIc8CsxaAyuRFN4lu2Ykfwe7mJuYMJWpWUbwKfXz3JWGmcfzyG7wqfMKmZoT1PwGNhi7JR_UhYW6K5A8w2TyjLuXMrAgje1jsuEBP5dGsuMYlto7MdAcKZStlFbF7ZEpCmaIK3T37irIePWGQE83jCFonqC65N64Y4JjJxGv2bsHaYAvnIyA53iRsSNnkzcY2rQqRuL-vweH1TMrVDS6_uccbHWqpTJ2wc0wxu6ApBM5cK65LhltAlnucJwYWI3UsQ8YwYsOVN5DqmQgjSbCdsKu6HQUILxpwEMgbWFWTx_XnBjYZaLWCujUjtDqefH89cnfDVPpquTM5iexunJdI73pvNVfHp8zNPT83hFhrid_uJDvJQMP2_WZPXFdOqvAl_pKf283WjgSSsy-OQnzPlHMIav4SoTh6SuEEMrHt9_1uqBIF0J1dBvbWluBfYE9t4qld0Ly_58eOc9udYUL9C35SlltPatfBBaSUqIEz0Urr7cAZ_bwNTGBQt7cRlS-3d64OXcpVdzMGx9FdPp75cM5MPd-10-mAUnEOb7kDFO8I_td9YEWvcsxBrxO9sqaRuO3IMVaFyNrFEeC5ciRvWg8JpbhmIxskKhVQGa6IkUaIhBPEDCgCrSNOqRDYTFqjVIKFlG33gHSSAXkmxDXdsN1q3E5YgAvZs1K-9wA7rpSxyZCYs38xvoHbPCmQYMmXsNSM1okduapVrlqBflAzD5au_g85t_Qp8pOXqd3KoWIWbBPvLi-42lFjAJoPM9WOZ3WAwhuJU60qUcjYNVoV-jHpWFcsZybT_BlvYeVanTNhR7DPIYgFtQDk258k5jHn0K0ZFZJTGiNiCQmcoEI-r6Sad3jNs0XCE1Wl3GFrl06iL-JUYdFir4vZNf_IZpKWMiUg8SHsdQUFr2ax4ZvNHOUIAU4S6pWBM8hCxK62leA_ZiaSqRPajj8iqUvSCOxmRRadA1bNCdpBPYCEAEPA8bhN42QE5gWdFo9S7FpdZgcBRIPIipoxJw2spwM0U3D6uMQhtq9SY7B6sMuHXeBCEddLvV2ibDQcnpxVaHbmCxg08wUBMF5neeoVw1SvhIoreux7pxAmcby4U0gVFbsn4rsEAxKNiXIS6xizIlY_B-egQxB0kTllTgblhQfcKCfvKcFGbdBVXan0soqxhcEwDc70DSsxR3_zvFdXdH_fvubrRuUDRhPYBOMBZBcU68nnFHD8jfaMs-kg6XZ1jWj_6rCegthczHp64KQtpGZYR_zFfCLW-mUCPyMuNt6RCsFA12eEN0CzwI6WyP2FrGDzJxVAXYSVwnC-YZLfRDZVCPVz3Wq28HnHe0ylR835NvpzMc8L7vb36LZfwLbjOwe4we_xXbjdK7BfuAF9Xm3zvZ4UWR7f4wI8JcBc7SplgsK6z8HltWyN3vlEHcLi7crJoiGV5eVkN-g8ZfgejwhBhiB_pXwJAIuxvcxQM3TIiEr_aNw8Som7axF_bPQoj74rvhKXz6gbUVKC8u-AoJHIfuy2a2CIAKLFB_A1VU3VGhrnl8gBglKkAakQCe_lZQN2TkWDfwB9PCrFsK-FcgdVYER5injllFqCbPumHhCSBR8pnfinbCJGHD5ytV2tCmOuBey14L7sQcdZtYixWM4qobhbgxjdt9dP3zX-PhRNwcXGKaNUMJODgpVMmozaM24bslsbKbnyhskkJMh1ABOJBVMs0iU_UpbA6YHSEf1D1GMCnbkqOBrMs4mI8-V2PIeQbaVuPV88-9PthMWjQsbrA0saUmYS72Ov63_21m6oxjnssXwXQQCOA2llJQE8-ioarh5rC32STQG6ZYyY_YV2sHRrVWGhLq6674T0SHGKF4YJGnB_zZMimr6dNRJcuxdLXg2YDOXyAftOQppQNjIYHq_dsqMViHWz_s4d1l1MJgGVWJNDN2bZ_150fs3rPmzELvK7BaN6rEA1DzQgQhkzm1Gn4rhUbc1a8y3DxeafDvL6jxqVKzotSFwnpv9Ib8gkDLANPsD_ekOVVZprYNltv5IwRvWPW9rrjunhv9BNKHarx3chzCU3_Z-Id7FdGhHXVYyEIxCljcty7iQjg0ZQDbcnqpglkVSMDW59rNtTRFujcbPPPEbFwMEAFI1zlwaeq5sdFHiLNwyw1CiTvq0YQJPanUV2-PmmODo3LRvD2aLWV4HDl0dBUSEUjWuXGz5vgWR7nCnIfYCdBh_JDrMt-2mCDgY69VSRxz3e1wtE6xbYjqgIqB897EvDonBNMwrfGj5hae6ZYu8fzkgr6MSLeoii9TaxFjAVHH5Pd4lnWARx2BRlMWhC2y--AIcgDFTw0iRwMzzLp_xv8BUO5B8BBge0OOfxnyfzf6KXN4kjTcKN0hrK7cd7Jz2CZqdoQ6ypopdYB2p9rxbVdy_PTguDfbDbk9PPntx-DwBIcVGk2iHHSO8I0WkdtwGSHCclhGC7xMIOVlZpfRUj6iaFng-QLeJgKH1GiBh3eYRLy06mYn42iR8sxALVS9lmzuFlxGi2_R12hxOjs_f316dvZ6_vLs1Xz-ahLtosX58exsfnI-P5-_evlyfnz68nES_UcpXP9iNj89m89fn744fTE_f3X8Yu6U_cM99CaAM-ijf0Hv3tM__hdBC-B5)](https://mermaid.live/edit#pako:eNqtWI1v27oR_1cIAUPtxXabJk1jIwjQl7VdgLboe8negM1DSksnm4tE6pFUXK8v_dt3R-qDkuW8FZgRxLJ0PN7H73531LcoVglEi-hPzYctJf67yrgxLBF8rXnOUqWZ3QB7r0WyVTpLjt7cMq7jjbAQ21IDi5U0IgEt5Bqv80JJkNYwkRcZ5HgJiVO72rHr9x_-5q7dP_rFYtoMDNvwB2Bcsi8Xl3T_C0sFZG5h_VlKv0qyYmc3SrIc8CsxaAyuRFN4lu2Ykfwe7mJuYMJWpWUbwKfXz3JWGmcfzyG7wqfMKmZoT1PwGNhi7JR_UhYW6K5A8w2TyjLuXMrAgje1jsuEBP5dGsuMYlto7MdAcKZStlFbF7ZEpCmaIK3T37irIePWGQE83jCFonqC65N64Y4JjJxGv2bsHaYAvnIyA53iRsSNnkzcY2rQqRuL-vweH1TMrVDS6_uccbHWqpTJ2wc0wxu6ApBM5cK65LhltAlnucJwYWI3UsQ8YwYsOVN5DqmQgjSbCdsKu6HQUILxpwEMgbWFWTx_XnBjYZaLWCujUjtDqefH89cnfDVPpquTM5iexunJdI73pvNVfHp8zNPT83hFhrid_uJDvJQMP2_WZPXFdOqvAl_pKf283WjgSSsy-OQnzPlHMIav4SoTh6SuEEMrHt9_1uqBIF0J1dBvbWluBfYE9t4qld0Ly_58eOc9udYUL9C35SlltPatfBBaSUqIEz0Urr7cAZ_bwNTGBQt7cRlS-3d64OXcpVdzMGx9FdPp75cM5MPd-10-mAUnEOb7kDFO8I_td9YEWvcsxBrxO9sqaRuO3IMVaFyNrFEeC5ciRvWg8JpbhmIxskKhVQGa6IkUaIhBPEDCgCrSNOqRDYTFqjVIKFlG33gHSSAXkmxDXdsN1q3E5YgAvZs1K-9wA7rpSxyZCYs38xvoHbPCmQYMmXsNSM1okduapVrlqBflAzD5au_g85t_Qp8pOXqd3KoWIWbBPvLi-42lFjAJoPM9WOZ3WAwhuJU60qUcjYNVoV-jHpWFcsZybT_BlvYeVanTNhR7DPIYgFtQDk258k5jHn0K0ZFZJTGiNiCQmcoEI-r6Sad3jNs0XCE1Wl3GFrl06iL-JUYdFir4vZNf_IZpKWMiUg8SHsdQUFr2ax4ZvNHOUIAU4S6pWBM8hCxK62leA_ZiaSqRPajj8iqUvSCOxmRRadA1bNCdpBPYCEAEPA8bhN42QE5gWdFo9S7FpdZgcBRIPIipoxJw2spwM0U3D6uMQhtq9SY7B6sMuHXeBCEddLvV2ibDQcnpxVaHbmCxg08wUBMF5neeoVw1SvhIoreux7pxAmcby4U0gVFbsn4rsEAxKNiXIS6xizIlY_B-egQxB0kTllTgblhQfcKCfvKcFGbdBVXan0soqxhcEwDc70DSsxR3_zvFdXdH_fvubrRuUDRhPYBOMBZBcU68nnFHD8jfaMs-kg6XZ1jWj_6rCegthczHp64KQtpGZYR_zFfCLW-mUCPyMuNt6RCsFA12eEN0CzwI6WyP2FrGDzJxVAXYSVwnC-YZLfRDZVCPVz3Wq28HnHe0ylR835NvpzMc8L7vb36LZfwLbjOwe4we_xXbjdK7BfuAF9Xm3zvZ4UWR7f4wI8JcBc7SplgsK6z8HltWyN3vlEHcLi7crJoiGV5eVkN-g8ZfgejwhBhiB_pXwJAIuxvcxQM3TIiEr_aNw8Som7axF_bPQoj74rvhKXz6gbUVKC8u-AoJHIfuy2a2CIAKLFB_A1VU3VGhrnl8gBglKkAakQCe_lZQN2TkWDfwB9PCrFsK-FcgdVYER5injllFqCbPumHhCSBR8pnfinbCJGHD5ytV2tCmOuBey14L7sQcdZtYixWM4qobhbgxjdt9dP3zX-PhRNwcXGKaNUMJODgpVMmozaM24bslsbKbnyhskkJMh1ABOJBVMs0iU_UpbA6YHSEf1D1GMCnbkqOBrMs4mI8-V2PIeQbaVuPV88-9PthMWjQsbrA0saUmYS72Ov63_21m6oxjnssXwXQQCOA2llJQE8-ioarh5rC32STQG6ZYyY_YV2sHRrVWGhLq6674T0SHGKF4YJGnB_zZMimr6dNRJcuxdLXg2YDOXyAftOQppQNjIYHq_dsqMViHWz_s4d1l1MJgGVWJNDN2bZ_150fs3rPmzELvK7BaN6rEA1DzQgQhkzm1Gn4rhUbc1a8y3DxeafDvL6jxqVKzotSFwnpv9Ib8gkDLANPsD_ekOVVZprYNltv5IwRvWPW9rrjunhv9BNKHarx3chzCU3_Z-Id7FdGhHXVYyEIxCljcty7iQjg0ZQDbcnqpglkVSMDW59rNtTRFujcbPPPEbFwMEAFI1zlwaeq5sdFHiLNwyw1CiTvq0YQJPanUV2-PmmODo3LRvD2aLWV4HDl0dBUSEUjWuXGz5vgWR7nCnIfYCdBh_JDrMt-2mCDgY69VSRxz3e1wtE6xbYjqgIqB897EvDonBNMwrfGj5hae6ZYu8fzkgr6MSLeoii9TaxFjAVHH5Pd4lnWARx2BRlMWhC2y--AIcgDFTw0iRwMzzLp_xv8BUO5B8BBge0OOfxnyfzf6KXN4kjTcKN0hrK7cd7Jz2CZqdoQ6ypopdYB2p9rxbVdy_PTguDfbDbk9PPntx-DwBIcVGk2iHHSO8I0WkdtwGSHCclhGC7xMIOVlZpfRUj6iaFng-QLeJgKH1GiBh3eYRLy06mYn42iR8sxALVS9lmzuFlxGi2_R12hxOjs_f316dvZ6_vLs1Xz-ahLtosX58exsfnI-P5-_evlyfnz68nES_UcpXP9iNj89m89fn744fTE_f3X8Yu6U_cM99CaAM-ijf0Hv3tM__hdBC-B5)